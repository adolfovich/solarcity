window.ASTC=function(){const r=t=>Math.max(0,Math.min(255,Math.round(t)));return{isTransparent:function(t){return!t||"transparent"===t||!!(t=t.match(/rgba\(\s*\d+,\s*\d+,\s*\d+,\s*([0-9.]+)\s*\)/i))&&0===parseFloat(t[1])},RGBToHex:function(t){return(t=t&&String(t).match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i))?"#"+r(+t[1]).toString(16).padStart(2,"0")+r(+t[2]).toString(16).padStart(2,"0")+r(+t[3]).toString(16).padStart(2,"0"):"#ffffff"},getContrast:function(t){let r=String(t).replace("#","").trim();3===r.length&&(r=r.split("").map(t=>t+t).join(""));var t=parseInt(r,16),a=t>>8&255,o=255&t;return(Math.round(299*(t>>16&255))+Math.round(587*a)+Math.round(114*o))/1e3},checkColor:function(t){return ASTC.getContrast(t)<125},checkColorBtn:function(t){return ASTC.getContrast(t)<180},getContrastColor:function(t){return ASTC.checkColor(t)?"#000000":"#ffffff"},getEffectiveBackgroundColor:function(t){var r,a=t.css("background-color");return ASTC.isTransparent(a)?(r=t.closest(".text_block")).length&&!ASTC.isTransparent(r.css("background-color"))?r.css("background-color"):(r=t.closest(".section")).length&&!ASTC.isTransparent(r.css("background-color"))?r.css("background-color"):"rgba(0, 0, 0, 0)":a},makeDarkOrLight:function(t){var r,t=$("#b_"+t);t.length&&(r=t.css("background-color"),ASTC.isTransparent(r)||(r=ASTC.RGBToHex(r))&&ASTC.checkColor(r)&&t.addClass("dark"),t.find(".bg_color").each(function(){var t=$(this),r=t.css("background-color");ASTC.isTransparent(r)||(r=(r=ASTC.RGBToHex(r))&&ASTC.checkColor(r),t.parent().removeClass("dark light").addClass(r?"dark":"light"))}),t.find([".menu1",".extra_info_block",".text_block",".col_3",".col_4",".txt_and_btn",".table .line",".icon_layer",".tile",".content-tile",".content-text",".spoiler"].join(", ")).each(function(){var t=$(this),r=ASTC.getEffectiveBackgroundColor(t);ASTC.isTransparent(r)||(r=ASTC.RGBToHex(r),t.toggleClass("dark",!(!r||!ASTC.checkColor(r))))}),t.find(".bg_right, .form_bg_color, .col_bg, .menu1 ul").each(function(){var t=$(this),r=ASTC.getEffectiveBackgroundColor(t);ASTC.isTransparent(r)||(r=ASTC.RGBToHex(r),t.parent().toggleClass("dark",!(!r||!ASTC.checkColor(r))))}))},makeDarkOrLightBTNs:function(t){t=$("#b_"+t);t.length&&t.find(".surround, .cookie_btn, .section1011 .next").each(function(){var t=$(this),r=t.css("background-color");ASTC.isTransparent(r)||(r=ASTC.RGBToHex(r),r=ASTC.checkColorBtn(r),t.toggleClass("dark",r))})},checkBackgroundImageInUse:function(t){t=$("#b_"+t).css("background-image");return!(!t||"none"===t)&&[...t.matchAll(/url\((['"]?)(.*?)\1\)/gi)].map(t=>t[2]).some(t=>!/null\.png/i.test(t))},

/* ====== Исправленная getImageAverageColor (с фильтрацией запрещённых URL) ====== */
getImageAverageColor:async function(t,r="default"){
    try{
        // Собираем URL-ы background-image
        const urls = [...(t.css("background-image")||"").matchAll(/url\(["']?([^"')]+)["']?\)/g)].map(m=>m[1]);
        if(!urls.length) return {r:255,g:255,b:255,a:1};

        // === Фильтрация запрещённых/проблемных файлов ===
        const forbidden = [
            "img/1920x0/4784c051ec1dc4767f763824a20b543b.jpg",
            "/img/1920x0/4784c051ec1dc4767f763824a20b543b.jpg",
            "http://solarcity23.local/img/1920x0/4784c051ec1dc4767f763824a20b543b.jpg",
            "https://solarcity23.local/img/1920x0/4784c051ec1dc4767f763824a20b543b.jpg"
        ];
        const filtered = urls.filter(u => !forbidden.some(bad => u.indexOf(bad) !== -1));
        if(!filtered.length) return {r:255,g:255,b:255,a:1};

        const url = filtered[filtered.length-1]; // последний (как в оригинале)

        // Функция загрузки изображения с корректной обработкой ошибок
        const loadImage = (u) => new Promise((resolve, reject) => {
            try{
                const img = new Image();
                img.crossOrigin = "Anonymous";
                let done = false;
                img.onload = function(){ if(done) return; done = true; resolve(img); };
                img.onerror = function(){ if(done) return; done = true; reject(new Error('Image load error: ' + u)); };
                img.src = u;
            }catch(e){
                reject(e);
            }
        });

        let o;
        try {
            o = await loadImage(url);
        } catch(e) {
            console.warn('ASTC: image not usable:', url, e);
            return {r:255,g:255,b:255,a:1}; // fallback white
        }

        // Дополнительная проверка (на всякий случай)
        if(!o || !o.complete || o.naturalWidth === 0){
            console.warn('ASTC: broken image after load:', url);
            return {r:255,g:255,b:255,a:1};
        }

        // Создаём canvas и рисуем уменьшенную версию
        var canv = document.createElement("canvas"), ctx = canv.getContext("2d");
        canv.width = Math.max(1, Math.floor(o.width / 4));
        canv.height = Math.max(1, Math.floor(o.height / 4));
        try{
            ctx.drawImage(o, 0, 0, canv.width, canv.height);
        }catch(e){
            console.warn('ASTC: drawImage failed for', url, e);
            return {r:255,g:255,b:255,a:1};
        }

        var e = canv.width, t_h = canv.height;
        let c, s;
        if("header" === r){
            c = Math.max(0, Math.floor(e/2 - 50));
            s = Math.max(0, Math.floor(.1 * t_h));
        } else {
            c = Math.max(0, Math.floor(e/2 - 50));
            s = Math.max(0, Math.floor(t_h/2 - 50));
        }
        var rw = Math.min(100, e - c), rh = Math.min(100, t_h - s);
        var imgData;
        try{
            imgData = ctx.getImageData(c, s, rw, rh).data;
        }catch(err){
            // Обычно происходит при CORS-ограничении — отдаём fallback
            console.warn('ASTC: getImageData failed (likely CORS):', err);
            return {r:255,g:255,b:255,a:1};
        }

        let lr=0, lg=0, lb=0;
        for(let i=0;i<imgData.length;i+=4){
            lr += imgData[i];
            lg += imgData[i+1];
            lb += imgData[i+2];
        }
        let pix = imgData.length / 4 || 1;
        return { r: Math.round(lr/pix), g: Math.round(lg/pix), b: Math.round(lb/pix), a: 1 };
    }catch(err){
        console.warn('ASTC: unexpected error in getImageAverageColor', err);
        return {r:255,g:255,b:255,a:1};
    }
},

/* ====== продолжение оригинального кода (оставлено без изменений) ====== */
getImageContrastColor:async function(t){if(!t||!ASTC.checkBackgroundImageInUse(t))return!1;var r=$("#b_"+t);if(!r.length)return!1;var[t,a]=await Promise.all([ASTC.getImageAverageColor(r,"default"),ASTC.getImageAverageColor(r,"header")]);let o=t,n=a;for(const i of[".dark",".back_dark",".layer",".headliner"]){var e,c=r.find(i);c.length&&(e=c.css("background-image"),/null\.png/i.test(e)||(e=ASTC.averageLayerColor(c,o).match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/))&&(o={r:+e[1],g:+e[2],b:+e[3],a:1},n=o))}t=ASTC.RGBToHex(`rgb(${o.r}, ${o.g}, ${o.b})`),a=ASTC.RGBToHex(`rgb(${n.r}, ${n.g}, ${n.b})`);const s=ASTC.checkColor(t);t=ASTC.checkColor(a);return r.removeClass("dark light").addClass(s?"dark":"light"),r.find(".title, .sub_title").removeClass("dark light").addClass(t?"dark":"light"),r.find(".bg_right, .form_bg_color, .col_bg").each(function(){var t=$(this).parent(),r=parseFloat($(this).css("opacity"))||1;t.removeClass("dark light"),s&&r<.5?t.addClass("dark"):!s&&r<.5&&t.addClass("light")}),!0},
averageLayerColor:function(t,r={r:255,g:255,b:255}){var t=window.getComputedStyle(t[0]),a=t.backgroundImage||"",t=t.backgroundColor||"",a=a.match(/rgba?\([^)]*\)/g)||[];if(!a.length&&t&&a.push(t),!a.length)return`rgba(${r.r}, ${r.g}, ${r.b}, 1)`;let o=0,n=0,e=0;for(const g of a){var c,s,i,l=g.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([0-9.]+))?\)/i);l&&(c=+l[1],s=+l[2],i=+l[3],l=void 0!==l[4]?parseFloat(l[4]):1,o+=c*l+r.r*(1-l),n+=s*l+r.g*(1-l),e+=i*l+r.b*(1-l))}t=a.length;return 0===t?`rgba(${r.r}, ${r.g}, ${r.b}, 1)`:`rgb(${Math.round(o/t)}, ${Math.round(n/t)}, ${Math.round(e/t)})`},checkSectionsColor:async function(){const r=[];$(".section").each(function(){var t=$(this).data("id");void 0!==t&&r.push(ASTC.getImageContrastColor(t))}),await Promise.all(r),$(".section").each(function(){var t=$(this).data("id");void 0!==t&&(ASTC.makeDarkOrLight(t),ASTC.makeDarkOrLightBTNs(t))})}}}(),$(function(){ASTC.checkSectionsColor(),$("body").on("change","input.choose_bg_color",function(){ASTC.checkSectionsColor()}),$(".menu1").each(function(){"rgb(51, 51, 51)"===$(this).css("color")&&$(this).closest(".section").hasClass("dark")&&$(this).css("color","")});var t=$(".clip_influx:not(.clip_none)");const o=t.length;t.each(function(t){var r=$(this),t=15+o-t,a=Math.round(-1*r.outerHeight()*.06)+"px";r.attr("style",(r.attr("style")||"")+"; --cliped-margin-bottom: "+a),r.css("z-index",t)})});
